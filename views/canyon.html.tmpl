<!DOCTYPE html>
<html lang="en">
  <head>
    <title>[LIVE] - LCC</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="charset" content="utf-8"><meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="theme-color" content="#f2f3f4">
    <meta name="msapplication-square310x310logo" content="icon_largetile.png">
    <meta name="Description" content="LCC Live">
    <link rel="stylesheet" href="/style.css">
  {{if eq .Name "LCC"}}
    <link rel="prefetch" href="/bcc" />
  {{else}}
    <link rel="prefetch" href="/" />
  {{end}}
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"> -->
    <!-- <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"> -->
    <!-- <link rel="icon" type="image/png" href="/favicon.ico"> -->
  </head>
  <body>
    <header>
      <nav class="canyon-toggle">
      {{if eq .Name "LCC"}}
        <a aria-current="page" class="active" href="/">LCC</a>
        <a class="" href="/bcc">BCC</a>
      {{else}}
        <a class="" href="/">LCC</a>
        <a aria-current="page" class="active" href="/bcc">BCC</a>
      {{end}}
      </nav>
      <road-status>
        <img id="img-{{.Status.ID}}" src="image/{{.Status.ID}}" alt="{{.Status.Alt}}">
      </road-status>
    </header>
    <section id="container">
    {{range .Cameras}}
    {{if ne .Kind "roadstatus"}}
      <camera-feed> <!-- TODO: tab index, and reload !-->
      {{if eq .Kind "iframe"}}
        <iframe 
          loading="lazy" 
          src="{{.Src}}" 
          title="{{.Alt}}" 
          frameborder="0" 
          fetchpriority=high
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
          referrerpolicy="strict-origin-when-cross-origin">
        </iframe>
      {{else}}
        <img id="img-{{.ID}}" src="/image/{{.ID}}" alt="{{.Alt}}" loading="lazy">
      {{end}}
        <h4>{{.Alt}}</h4>
      </camera-feed>
    {{end}}
    {{end}}
    </section>
    <the-overlay></the-overlay>
    <script>
    // Create a new EventSource connected to our SSE endpoint
    const eventSource = new EventSource('/events');

    function reloadImage(img) {
      // Extract the original src without query parameters
      const originalSrc = img.src.split('?')[0];
      // Append a unique timestamp to the URL
      img.src = `${originalSrc}?t=${new Date().getTime()}`;
    }

    // Listen for messages from the server
    eventSource.onmessage = function(event) {
      console.log("tick", event.data)
      for (const img of [...document.querySelectorAll("img")]) {
          reloadImage(img)
      }
    };

    eventSource.onerror = function(err) {
      console.error("EventSource failed:", err);
      eventSource.close();
    };
    </script>
  </body>
</html>
